name: Integration Tests (Nightly)

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      language:
        description: 'Specific language to test (leave empty for all)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - python
          - javascript
          - typescript
          - c
          - cpp
          - csharp
          - go
          - rust

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -Dwarnings

jobs:
  # Real-world repository tests (Tier 2)
  realworld:
    name: Real-World Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: [python, javascript, typescript, c, cpp, csharp, go, rust]
    # Skip if manual trigger with specific language doesn't match
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.language == '' || github.event.inputs.language == matrix.language }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-nightly-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-nightly-
            ${{ runner.os }}-cargo-

      - name: Cache test repositories
        uses: actions/cache@v4
        with:
          path: crates/codeprysm-core/target/test-repos
          key: test-repos-${{ matrix.language }}-v1
          restore-keys: |
            test-repos-${{ matrix.language }}-

      - name: Run ${{ matrix.language }} real-world tests
        run: |
          cargo test --package codeprysm-core --test realworld_tests ${{ matrix.language }} -- --ignored --nocapture
        timeout-minutes: 30

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: realworld-${{ matrix.language }}-failure
          path: |
            crates/codeprysm-core/target/test-repos/
            target/test-artifacts/
          retention-days: 7

  # Summary job that runs all tests together
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: realworld
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-nightly-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-nightly-
            ${{ runner.os }}-cargo-

      - name: Generate summary report
        run: |
          echo "# Nightly Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Language | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Get job results from context
          PYTHON="${{ needs.realworld.result }}"
          echo "| Python | ${PYTHON:-skipped} |" >> $GITHUB_STEP_SUMMARY
          echo "| JavaScript | ${PYTHON:-skipped} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${PYTHON:-skipped} |" >> $GITHUB_STEP_SUMMARY
          echo "| C | ${PYTHON:-skipped} |" >> $GITHUB_STEP_SUMMARY
          echo "| C++ | ${PYTHON:-skipped} |" >> $GITHUB_STEP_SUMMARY
          echo "| C# | ${PYTHON:-skipped} |" >> $GITHUB_STEP_SUMMARY
          echo "| Go | ${PYTHON:-skipped} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust | ${PYTHON:-skipped} |" >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        if: needs.realworld.result == 'failure'
        run: |
          echo "Some real-world tests failed. Check individual job logs for details."
          exit 1

  # Notify on failure (optional - requires secrets configuration)
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [realworld, summary]
    if: failure() && github.event_name == 'schedule'
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Nightly Integration Tests Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Nightly Integration Tests Failed

            The nightly integration tests have failed. Please investigate.

            **Workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

            **Date:** ${new Date().toISOString()}
            `;

            // Check if there's already an open issue with this title pattern
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'nightly-failure'
            });

            const existingIssue = issues.data.find(i => i.title.startsWith('Nightly Integration Tests Failed'));

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['nightly-failure', 'bug']
              });
            } else {
              // Add a comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Another nightly failure detected.\n\n**Workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
              });
            }
